---
title: "R Notebook"
output: html_notebook
---


```{r}
library(reticulate)
library(sf)
library(tidyverse)
library(reshape2)
library(viridis)
library(ape)
model = readRDS("./model.rds")
```

Load model residuals

```{r}
res = model$residuals
df = model$data
res_df = tibble(
  fips=model$data$fips,
  res=model$residuals,
  t=model$data$days_since_intrv_stayhome
)
res_df
```


Download shapefile


```{python}
import networkx as nx
import pandas as pd
import os
import wget
from zipfile import ZipFile 

url = 'https://www2.census.gov/geo/tiger/TIGER2020/COUNTY/tl_2020_us_county.zip'
# wget.download(url, './tmp')
file_name = './tmp/tl_2020_us_county.zip'
# ZipFile(file_name, 'r').extractall('./tmp')
```


```{r}
gdf = st_read("tmp/tl_2020_us_county.shp")
```

```{r}
t_comparison = 14
df_t = filter(df, days_since_intrv_stayhome == t_comparison)
res_df_t = res_df %>% 
  filter(t == t_comparison)
```

Distribution of residuals for fixed epidemic time of two weeks

```{r}
q05 = quantile(res_df_t$res, .05)
ggplot(res_df_t) + 
  geom_histogram(aes(x=res), bins=60) +
  geom_vline(aes(xintercept=q05, color="5%"), lty=2) +
  theme_bw() +
  scale_color_manual(values="red") +
  labs(
    title=sprintf("Residuals for epidemic time %d", t_comparison),
    color=""
  )
```

Chopping the 5% and 95% tails to visualize better.

```{r}
q05 = quantile(res_df_t$res, .05)
q95 = quantile(res_df_t$res, .95)
ggplot(filter(res_df_t, q05 < res, res < q95)) + 
  geom_histogram(aes(x=res), bins=30) +
  theme_bw() +
  labs(
    title=sprintf("Residuals for epidemic time %d", t_comparison),
    subtitle="5% tail removed"
  )

```

```{r}
gdf_res_at_t = gdf %>% 
  left_join(select(res_df_t, -t), by=c("GEOID"="fips")) %>% 
  rename(residual=res) %>% 
  filter(!is.na(residual)) %>% 
  mutate(outlier_lower_tail=residual < q05) %>% 
  mutate(residual=pmax(residual, q05))
```

```{r}
usa = st_as_sf(maps::map("state", fill=TRUE, plot =FALSE))

ggplot() +
  geom_sf(color = "#2b2b2b", fill = "white", size=0.125, data=usa) + 
  geom_sf(data=gdf_res_at_t, aes(fill=residual), size=0.125, lwd=0.0) +
  geom_sf(data=filter(gdf_res_at_t, outlier_lower_tail), fill="red") +
  coord_sf(xlim=c(-125, -77)) +
  scale_fill_viridis() +
  labs(
    title="Geographic distribution of residuals",
    subtitle="Lower 5% tail shown in red"
  ) +
  theme_minimal() +
  theme(panel.grid.major = element_blank())
```


Average autocorrelation





Moran's I

```{r}
distmat_raw = read_rds("tmp/OD.rds")
distmat_raw = distmat_raw + t(distmat_raw)
distmat = distmat_raw %>%
  rownames_to_column() %>% 
  pivot_longer(-rowname) %>%
  `names<-`(c("src", "tgt", "dist")) %>% 
  mutate(weight=ifelse(src != tgt, 1 / dist, 0))
distmat
```

Matrix form of Moran's I


With the full sample there is the appearance of huge spatial correlation with Moran's I


```{r}
# Residuals and weights
x = res_df_t$res
insample = x > -Inf
print(sprintf("excluding bottom %s", sum(!insample)))
x = x[insample]
fips = res_df_t$fips[insample]
wts = 1 / distmat_raw[fips, fips]


# Manual computation of Moran's I
c_t = mean(x)
x_c = x - c_t
diag(wts) = 0
ss_tot = sum(x_c * x_c)
covmat = wts * (x_c %*% t(x_c))
N = length(x)
W = sum(wts)
moran_mat = N / W * covmat / ss_tot
moran_I = sum(moran_mat)

# From package
Moran.I(x, wts, scaled=TRUE)  # from package
```
```{r}
local_moran = N * apply(moran_mat, 2, sum)
ggplot() +
  geom_histogram(aes(x=local_moran)) +
  theme_bw() +
  labs(
    title="Row (location) contributions to Moran's I",
    x=""
  )
```

With the exclusion of bottom 5% there is no spatial correlation.

```{r}
# residuals and weights
x = res_df_t$res
insample = x > quantile(x, .05)
print(sprintf("excluding bottom 5%% (%d/420)", sum(!insample)))
x = x[insample]
fips = res_df_t$fips[insample]
wts = 1 / distmat_raw[fips, fips]

# manual computation of Moran's I
c_t = mean(x)
x_c = x - c_t
diag(wts) = 0
ss_tot = sum(x_c * x_c)
covmat = wts * (x_c %*% t(x_c))
N = length(x)
W = sum(wts)
moran_mat = N / W * covmat / ss_tot
moran_I = sum(moran_mat)

# From package
Moran.I(x, wts, scaled=TRUE)  # from package
```

```{r}
local_moran = N * apply(moran_mat, 2, sum)
ggplot() +
  geom_histogram(aes(x=local_moran)) +
  theme_bw() +
  labs(
    title="Row (location) contributions to Moran's I",
    subtitle="Lower 5% tail excluded from Moran's I computation",
    x=""
  )
```
 
 Spatial visualization
 
```{r}
local_moran_df = tibble(
  moran=local_moran,
  fips=fips
)

gdf_moran_at_t = gdf %>% 
  left_join(local_moran_df, by=c("GEOID"="fips")) %>% 
  filter(!is.na(moran))

ggplot() +
  geom_sf(color = "#2b2b2b", fill = "white", size=0.125, data=usa) + 
  geom_sf(data=gdf_moran_at_t, aes(fill=moran), size=0.0) +
  geom_sf(data=filter(gdf_res_at_t, outlier_lower_tail), fill="red") +
  coord_sf(xlim=c(-125, -77)) +
  scale_fill_viridis() +
  labs(
    title="Geographic distribution of Local Correlation",
    subtitle="Lower 5% tail shown in red"
  ) +
  theme_minimal() +
  theme(panel.grid.major = element_blank())
```
 
