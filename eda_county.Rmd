
## county_desc

```{r, include=FALSE}
library(tidyverse)
library(magrittr)
library(feather)
library(usmap)
```

```{r}
county_desc <- read_feather("./county_desc.feather")
```

```{r}
summary(county_desc)
```

```{r}
county_desc %>% 
  select(fips, stayhome, gt50, gt500, schools, restaurants, entertainment) %>% 
  gather(key, value, -fips) %>% 
  filter(!is.na(value)) %>% 
  ggplot(aes(x = value, fill = key)) + 
  geom_bar() + 
  ggtitle("Intervention Dates")
```


```{r}
quantile(as.numeric(county_desc$gt50 - county_desc$gt500), c(0.15, 0.5, 0.85), na.rm = TRUE)
```

```{r}
quantile(as.numeric(county_desc$entertainment - county_desc$restaurants), c(0.15, 0.5, 0.85), na.rm = TRUE)
```

```{r}
quantile(as.numeric(county_desc$gt50 - county_desc$schools), c(0.15, 0.5, 0.85), na.rm = TRUE)
quantile(as.numeric(county_desc$restaurants - county_desc$schools), c(0.15, 0.5, 0.85), na.rm = TRUE)
```

```{r}
#stayhome, gt50, gt500, schools, restaurants, entertainment
quantile(as.numeric(county_desc$gt50 - county_desc$stayhome), c(0.15, 0.85), na.rm = TRUE)
quantile(as.numeric(county_desc$stayhome - county_desc$schools), c(0.15, 0.5, 0.85), na.rm = TRUE)
quantile(as.numeric(county_desc$restaurants - county_desc$stayhome), c(0.15, 0.85), na.rm = TRUE)
```

```{r}
county_desc %>% 
  select(fips, stayhome, gt50, gt500, schools, restaurants, entertainment) %>% 
  gather(key, value, -fips) %>% 
  group_by(key) %>% 
  summarize(no_intervention = sum(is.na(value)))
```

```{r}
county_map <- county_desc %>% 
  select(fips, stayhome) %>% 
  filter(!is.na(stayhome)) %>% 
  mutate(stayhome = strftime(stayhome, format = "%V"))

plot_usmap(data = county_map, include = county_map$fips, 
           values = "stayhome") +
  theme(legend.position = "right") + 
  theme(legend.title = element_blank()) + 
  scale_fill_manual(values = c("green","yellow","red","black"))
```

```{r}
county_map <- county_desc %>% 
  select(fips, gt50) %>% 
  filter(!is.na(gt50)) %>% 
  mutate(gt50 = strftime(gt50, format = "%V"))

plot_usmap(data = county_map, include = county_map$fips, 
           values = "gt50") +
  theme(legend.position = "right") + 
  theme(legend.title = element_blank()) + 
  scale_fill_manual(values = c("green","yellow","red","black"))
```

```{r}
county_map <- county_desc %>% 
  select(fips, schools) %>% 
  filter(!is.na(schools)) %>% 
  mutate(schools = strftime(schools, format = "%V"))

plot_usmap(data = county_map, include = county_map$fips, 
           values = "schools") +
  theme(legend.position = "right") + 
  theme(legend.title = element_blank()) + 
  scale_fill_manual(values = c("green","yellow","red","black"))
```

```{r}
county_map <- county_desc %>% 
  select(fips, restaurants) %>% 
  filter(!is.na(restaurants)) %>% 
  mutate(restaurants = strftime(restaurants, format = "%V"))

plot_usmap(data = county_map, include = county_map$fips, 
           values = "restaurants") +
  theme(legend.position = "right") + 
  theme(legend.title = element_blank()) + 
  scale_fill_manual(values = c("blue","green","yellow","red","black"))
```

## county_raw

```{r, include=FALSE}
library(tidyverse)
library(magrittr)
library(feather)
library(lubridate)
library(usmap)
```

```{r}
#county_raw <- read_feather("./county_raw.feather")
source("./county_raw.R")
```

```{r}
max(county_raw$date, na.rm = TRUE)
```


```{r}
county_raw[is.na(county_raw$county), c("state_code", "county_name")]
```

```{r}
# Counties with NA cases in county_counts. This might be because there are no cases or the county ID is not available in the raw data

county_map <- county_raw %>% 
  distinct(fips, county) %>% 
  mutate(no_counts = as.factor(!is.na(county)))

plot_usmap(data = county_map, values = "no_counts") +
  theme(legend.position = "right") + 
  scale_fill_manual(values=c("red", "white")) +
  theme(legend.title = element_blank())
```

## county_clean

```{r, include=FALSE}
library(tidyverse)
library(magrittr)
library(feather)
library(usmap)
```

```{r}
#county_clean <- read_feather("./county_clean.feather")
source("./county_clean.R")
```

```{r}
county_clean %>% 
  filter(index_desc == 1) %>% summary()
```

```{r}
county_map <- county_clean %>% 
  filter(index_desc == 1, 
         cum_cases_per_cap > 0) %>% 
  mutate(cum_cases_per_cap = log(cum_cases_per_cap))

plot_usmap(data = county_map,  
           include = county_map$fips, values = "cum_cases_per_cap") +
  theme(legend.position = "right") + 
  theme(legend.title = element_blank()) +
  scale_fill_continuous(low = "white",
                        high = "red",
                        name = " ")
```

```{r}
county_map <- county_clean %>% 
  filter(index_desc == 1, 
         cum_deaths_per_cap > 0) %>% 
  mutate(cum_deaths_per_cap = log(cum_deaths_per_cap))

plot_usmap(data = county_map, 
           include = county_map$fips, values = "cum_deaths_per_cap") +
  theme(legend.position = "right") + 
  theme(legend.title = element_blank()) +
  scale_fill_continuous(low = "white",
                        high = "red",
                        name = " ")
```

## county_features

```{r, include=FALSE}
library(tidyverse)
library(magrittr)
library(feather)
library(usmap)
```

```{r}
#county_features <- read_feather("./county_features.feather")
source("./county_features.R")
```

```{r}
county_features %>% 
  filter(index_desc == 1, 
         is.na(threshold_day)) %>% 
  select(county, state)
```

```{r}
county_features %>% 
  filter(index_desc == 1, 
         !is.na(threshold_day)) %>% 
  mutate(week_num = as.numeric(strftime(threshold_day, format = "%V")), 
         week_num = if_else(week_num < 11, 0, week_num), 
         week_num = if_else(week_num > 15, 0, week_num), 
         week_num = as.factor(week_num)) %>%
  ggplot(aes(x = threshold_day, fill = week_num)) + 
  geom_bar() +
  scale_fill_manual(values = c("grey", "blue", "green", 
                               "yellow", "red", "black")) + 
  labs(title = "Counties threshold day")
```

```{r}
county_features %>% 
  filter(index_desc == 1, 
         !is.na(threshold_day), 
         !is.na(stayhome)) %>% 
  pull(days_btwn_stayhome_thresh) %>% summary
```

```{r}
county_map <- county_features %>% 
  filter(index_desc == 1, 
         !is.na(threshold_day), 
         !is.na(stayhome))

plot_usmap(data = county_map, include = county_map$fips, 
           values = "threshold_day") +
  theme(legend.position = "right") + 
  theme(legend.title = element_blank()) 
```

```{r}
## Include only deaths up to May 21
county_features %<>% 
  filter(!is.na(threshold_day), 
         threshold_day <= as.Date("2020-05-21"),
         date <= as.Date("2020-05-21"))

## Require at least 15 days since threshold
remove_fips <- county_features %>% 
  group_by(fips) %>% 
  summarise(max_days = max(days_since_thresh)) %>% 
  filter(max_days < 15) %>% 
  pull(fips)

county_features <- county_features[!county_features$fips %in% remove_fips, ]
#length(unique(county_features$fips))

county_features %<>% 
  group_by(fips) %>% 
  arrange(date) %>% 
  mutate(index = row_number(), 
         index_desc = sort(index, decreasing = TRUE)) %>% 
  ungroup()

county_map <- county_features %>% 
  filter(index_desc == 1, 
         !is.na(threshold_day), 
         !is.na(stayhome))

plot_usmap(data = county_map, include = county_map$fips, 
           values = "threshold_day") +
  theme(legend.position = "right") + 
  theme(legend.title = element_blank()) 
```

```{r}
cum_deaths_ <- county_features %>% 
  filter(index_desc == 1) %>% 
  pull(cum_deaths)

summary(cum_deaths_)
```

```{r}
## Make smaller dataset
county_map <- county_features %>% 
  filter(index_desc == 1, 
         !is.na(threshold_day), 
         !is.na(stayhome)) %>% 
  mutate(train = cum_deaths >= quantile(cum_deaths_, 0.6))

plot_usmap(data = county_map, include = county_map$fips, 
           values = "train") +
  theme(legend.position = "right") + 
  theme(legend.title = element_blank()) + 
  scale_fill_manual(values = c("red", "white"))
```

## county_train

```{r, include=FALSE}
library(tidyverse)
library(magrittr)
library(feather)
library(usmap)
```

```{r}
#county_train <- read_feather("./county_train.feather")
source("./county_train.R")
```

```{r}
county_train %>% 
  filter(index_desc == 1,) %>% 
  mutate(week_num = as.numeric(strftime(threshold_day, format = "%V")), 
         week_num = if_else(week_num < 11, 0, week_num), 
         week_num = if_else(week_num > 15, 0, week_num), 
         week_num = as.factor(week_num)) %>%
  ggplot(aes(x = threshold_day, fill = week_num)) + 
  geom_bar() +
  scale_fill_manual(values = c("grey", "blue", "green", 
                               "yellow", "red", "black")) + 
  labs(title = "Counties threshold day")
```

```{r}
county_train %>% 
  filter(index_desc == 1, 
         !is.na(threshold_day), 
         !is.na(stayhome)) %>% 
  pull(days_btwn_stayhome_thresh) %>% summary
```

```{r}
county_map <- county_train %>% 
  filter(index_desc == 1, 
         !is.na(threshold_day), 
         !is.na(stayhome)) %>% 
  mutate(days_btwn_stayhome_thresh = -days_btwn_stayhome_thresh)

plot_usmap(data = county_map, include = county_map$fips, 
           values = "threshold_day") +
  theme(legend.position = "right") + 
  theme(legend.title = element_blank()) 
```
