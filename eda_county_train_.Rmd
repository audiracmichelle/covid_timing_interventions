
```{r, include=FALSE}
library(tidyverse)
library(magrittr)
library(feather)
#library(lubridate)
library(usmap)
library(viridis)
library(gridExtra)
```

## county_train_

```{r}
county_train_stayhome <- read_feather('./county_train_stayhome.feather')
county_train_decrease <- read_feather('./county_train_decrease.feather')
```

```{r}
xx <- county_train_stayhome %>% 
  distinct(fips, nchs, threshold_day, 
           gt50, gt500, schools, restaurants, entertainment, stayhome,
           decrease_50_total_visiting, 
           decrease_on_stayhome, 
           roll_decrease_on_stayhome, 
           min_decrease)
yy <- county_train_decrease %>% 
  distinct(fips, nchs, threshold_day, 
           gt50, gt500, schools, restaurants, entertainment, stayhome, 
           decrease_50_total_visiting, 
           decrease_on_stayhome, 
           roll_decrease_on_stayhome, 
           min_decrease)
length(unique(c(xx$fips, yy$fips)))
zz <- full_join(xx, yy)
table(zz$nchs)
```

```{r}
zz %>% 
  select(fips, gt50, gt500, schools, restaurants, entertainment, stayhome) %>% 
  gather(key, value, -fips) %>% 
  ggplot(aes(x = value, fill = key)) + 
  geom_bar() + 
  ggtitle("Intervention Dates")
```

```{r}
x <- as.numeric(c(zz$gt50 - zz$stayhome, zz$gt50 - zz$stayhome))
summary(x)
x <- as.numeric(c(zz$restaurants - zz$stayhome, zz$entertainment - zz$stayhome))
summary(x)
x <- as.numeric(c(zz$schools - zz$stayhome))
summary(x)
```

```{r}
summary(c(zz$gt50, 
          zz$gt500, 
          zz$schools, 
          zz$entertainment, 
          zz$restaurants))
summary(zz$stayhome)
tapply(zz$stayhome, zz$nchs, summary)
```

```{r}
summary(zz$decrease_50_total_visiting)
tapply(zz$decrease_50_total_visiting, zz$nchs, summary)
```

```{r}
zz %>% 
  group_by(decrease_50_total_visiting) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  mutate(cum_n = cumsum(n)) %>% 
  ggplot() + 
  geom_line(aes(x = decrease_50_total_visiting, y = cum_n))

zz %>% 
  ggplot() +
  geom_bar(aes(x = decrease_50_total_visiting, fill = nchs))
```

```{r}
p_intrv <- zz %>% 
  select(fips, gt50, gt500, schools, restaurants, entertainment, stayhome) %>% 
  gather(key, value, -fips)

p_decrease <- zz %>% 
  group_by(decrease_50_total_visiting) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  mutate(cum_n = cumsum(n)) 

ggplot(p_intrv) + 
  geom_bar(aes(x = value, fill = key)) + 
  geom_line(data = p_decrease, aes(x = decrease_50_total_visiting, y = cum_n))
```

```{r}
zz %>% 
  group_by(schools, nchs) %>% 
    summarise(n = n()) %>% 
  ungroup() %>% 
  arrange(nchs, schools) %>% 
  group_by(nchs) %>% 
    mutate(cum_n = cumsum(n)) %>% 
  ungroup() %>% 
  ggplot() +
    geom_line(aes(x = schools, y = cum_n, col = nchs))
  
```

```{r}
zz %>% 
  group_by(stayhome, nchs) %>% 
    summarise(n = n()) %>% 
  ungroup() %>% 
  arrange(nchs, stayhome) %>% 
  group_by(nchs) %>% 
    mutate(cum_n = cumsum(n)) %>% 
  ungroup() %>% 
  ggplot() +
    geom_line(aes(x = stayhome, y = cum_n, col = nchs))
  
```

```{r}
zz %>% 
  group_by(decrease_50_total_visiting, nchs) %>% 
    summarise(n = n()) %>% 
  ungroup() %>% 
  arrange(nchs, decrease_50_total_visiting) %>% 
  group_by(nchs) %>% 
    mutate(cum_n = cumsum(n)) %>% 
  ungroup() %>% 
  ggplot() +
    geom_line(aes(x = decrease_50_total_visiting, y = cum_n, col = nchs))
  
```

```{r}
zz %>% 
  group_by(threshold_day, nchs) %>% 
    summarise(n = n()) %>% 
  ungroup() %>% 
  arrange(nchs, threshold_day) %>% 
  group_by(nchs) %>% 
    mutate(cum_n = cumsum(n)) %>% 
  ungroup() %>% 
  ggplot() +
    geom_line(aes(x = threshold_day, y = cum_n, col = nchs))
  
```


```{r}
zz %>% 
  ggplot() + 
  geom_density(aes(x = decrease_on_stayhome, col = nchs))

zz %>% 
  ggplot() + 
  geom_density(aes(x = roll_decrease_on_stayhome, col = nchs))

zz %>% 
  ggplot() + 
  geom_density(aes(x = min_decrease, col = nchs))
```







