
```{r, include=FALSE}
library(tidyverse)
library(magrittr)
library(feather)
library(lubridate)
library(plotly)
library(zoo)
```

```{r}
source('./county_features.R')
rm(list = c("county_cases_desc", "county_features"))
```

```{r}
safegr <- read_feather("./safegr_raw.feather")
```

```{r}
safegr %>% 
  filter(key == "hometime_sd") %>% 
  pull(value) %>% summary
```

```{r}
safegr$value[safegr$key == "hometime_sd"] <- 1440 - safegr$value[safegr$key == "hometime_sd"]
```


```{r}
xx <- safegr %>% 
  group_by(fips, key) %>% 
  summarise(max_date = max(date))

summary(xx$max_date)
```

```{r}
xx %<>% 
  mutate(id = paste(fips, key, sep = "_")) %>% 
  filter(max_date < as.Date("2020-05-05"))

safegr %<>% 
  filter(!(paste(fips, key, sep = "_") %in% xx$id))
```

```{r}
xx <- safegr %>% 
  group_by(fips, key) %>% 
  summarise(min_date = min(date))

summary(xx$min_date)
```

```{r}
xx %<>% 
  mutate(id = paste(fips, key, sep = "_")) %>% 
  filter(min_date > as.Date("2020-01-05"))

safegr %<>% 
  filter(!(paste(fips, key, sep = "_") %in% xx$id))
```

```{r}
xx <- safegr %>% 
  group_by(fips, key) %>% 
  summarise(n = n())

summary(xx$n)
```

```{r}
xx %<>% 
  mutate(id = paste(fips, key, sep = "_")) %>% 
  filter(n < 130)

safegr %<>% 
  filter(!(paste(fips, key, sep = "_") %in% xx$id))
```

```{r}
ggplotly(safegr %>%
                filter(fips == "48453")  %>%
                ggplot() +
                geom_line(aes(x = date, y = value, color = key)))
```

```{r}
safegr %<>% 
  group_by(fips, key) %>% 
  arrange(date) %>% 
  mutate(week = as.numeric(rollmean(value, 7, fill = NA))) %>% 
  ungroup()
```

```{r}
ggplotly(safegr %>%
                filter(fips == "48453")  %>%
                ggplot() +
                geom_line(aes(x = date, y = week, color = key)))
```

```{r}
## Baseline 

get_baseline <- function(date, x) {
  mean(x[date >= as.Date("2020-01-15") & date <= as.Date("2020-02-15")])
}

safegr %<>% 
  group_by(fips, key) %>% 
  mutate(baseline = get_baseline(date, value)) %>%
  ungroup()
```

```{r}
xx <- safegr %>% 
  distinct(fips, key, baseline) 

tapply(xx$baseline, xx$key, summary)
```

```{r}
safegr %>% 
  group_by(key) %>%
  summarise(min = min(baseline),
    q10 = quantile(baseline, 0.1), 
    q20 = quantile(baseline, 0.2))
```

```{r}
for(k in unique(safegr$key)) {
  baseline_ <- safegr %>% 
    filter(key == k) %>% 
    distinct(fips, key, baseline) %>% 
    pull(baseline)
  
  safegr %<>% 
    filter(!((key == k) & (baseline < quantile(baseline_, 0.2))))
}
```

```{r}
safegr %<>% 
  mutate(relative_week = week / baseline) 
```

```{r}
ggplotly(safegr %>%
                filter(fips == "48453")  %>%
                ggplot() +
                geom_line(aes(x = date, y = relative_week, color = key)))
```

```{r}
safegr %<>% 
  group_by(fips, key) %>% 
  mutate(roll_relative_week = rollapply(relative_week, 10, mean, 
                               fill = NA, align = "right")) %>% 
  ungroup() %>% 
  mutate(roll_relative_week = as.numeric(roll_relative_week))
```

```{r}
ggplotly(safegr %>%
                filter(fips == "48453")  %>%
                ggplot() +
                geom_line(aes(x = date, y = roll_relative_week, color = key)))
```

```{r}
safegr %<>% 
  filter(date > "2020-02-15", 
         !is.na(week))
```

```{r}
safegr %<>% 
  group_by(fips, key) %>%
  mutate(min_relative = min(roll_relative_week, na.rm = TRUE)) %>% 
  ungroup()

xx <- safegr %>%distinct(fips, key, min_relative)
summary(xx$min_relative)
```

```{r}
xx <- safegr %>% 
  distinct(fips, key, min_relative) 

tapply(xx$min_relative, xx$key, summary)
```

```{r}
safegr$decrease_40 <- safegr$date
safegr$decrease_40[safegr$roll_relative_week > 0.6] <- as.Date("2020-12-31")

safegr %<>% 
  group_by(fips, key) %>% 
  mutate(decrease_40 = min(decrease_40)) %>% 
  ungroup()

safegr$decrease_40[safegr$decrease_40 == as.Date("2020-12-31")] <- NA

safegr %>% 
  distinct(fips, key, decrease_40) %>% 
  pull(decrease_40) %>% summary
```

```{r}
xx <- safegr %>% 
  distinct(fips, key, decrease_40) 

tapply(xx$decrease_40, xx$key, summary)
```

```{r}
safegr$decrease_50 <- safegr$date
safegr$decrease_50[safegr$roll_relative_week > 0.5] <- as.Date("2020-12-31")

safegr %<>% 
  group_by(fips, key) %>% 
  mutate(decrease_50 = min(decrease_50)) %>% 
  ungroup()

safegr$decrease_50[safegr$decrease_50 == as.Date("2020-12-31")] <- NA

safegr %>% 
  distinct(fips, key, decrease_50) %>% 
  pull(decrease_50) %>% summary
```

```{r}
xx <- safegr %>% 
  distinct(fips, key, decrease_50) 

tapply(xx$decrease_50, xx$key, summary)
```

```{r}
#safegr %>% select(fips, key, date, relative_week, contains("decrease")) %>% head(5000) %>% view()

safegr$decrease_60 <- safegr$date

safegr$decrease_60[safegr$roll_relative_week > 0.4] <- as.Date("2020-12-31")

safegr %<>% 
  group_by(fips, key) %>% 
  mutate(decrease_60 = min(decrease_60)) %>% 
  ungroup()

safegr$decrease_60[safegr$decrease_60 == as.Date("2020-12-31")] <- NA

safegr %>% 
  distinct(fips, key, decrease_60) %>% 
  pull(decrease_60) %>% summary
```

```{r}
xx <- safegr %>% 
  distinct(fips, key, decrease_60) 

tapply(xx$decrease_60, xx$key, summary)
```

```{r}
county_deaths_desc_ <- county_deaths_desc %>% 
  left_join(safegr %>% 
              rename(stayhome = date) %>%
              filter(key == "total_visiting") %>% 
              select(fips, stayhome, relative_week, roll_relative_week, min_relative)) %>% 
  rename(decrease_on_stayhome = relative_week, 
         roll_decrease_on_stayhome = roll_relative_week,
         min_decrease = min_relative)

write_feather(county_deaths_desc_, "county_deaths_desc_.feather")
```

```{r}
county_deaths_desc_ %>% 
  filter(fips == "48453") %>% 
  select(stayhome, roll_decrease_on_stayhome, decrease_on_stayhome)
```


```{r}
safegr %>%
  distinct(fips, key,
           baseline, min_relative,
           decrease_40, decrease_50, decrease_60) %>% 
  write_feather("safegr.feather")
```

```{r}
county_train_stayhome <- read_feather('./county_train_stayhome.feather')
county_train_decrease <- read_feather('./county_train_decrease.feather')
```

```{r}
xx <- county_train_stayhome %>% 
  distinct(fips, nchs, stayhome)
yy <- county_train_decrease %>% 
  distinct(fips, nchs, stayhome)
length(unique(c(xx$fips, yy$fips)))
zz <- full_join(xx, yy)
table(zz$nchs)
```

```{r}
zz %>% 
  rename(date = stayhome) %>% 
  left_join(safegr %>% 
              filter(key == "total_visiting") %>% 
              select(fips, date, roll_relative_week)) %>% 
  ggplot() +
  geom_density(aes(x = roll_relative_week, col = nchs))

zz %>% 
  rename(date = stayhome) %>% 
  left_join(safegr %>% 
              filter(key == "total_visiting") %>% 
              select(fips, date, relative_week)) %>% 
  ggplot() +
  geom_density(aes(x = relative_week, col = nchs))
```

```{r}
zz %>% 
  rename(date = stayhome) %>% 
  left_join(safegr %>% 
              filter(key == "total_visiting") %>% 
              select(fips, date, min_relative)) %>% 
  ggplot() +
  geom_density(aes(x = min_relative, col = nchs))
```